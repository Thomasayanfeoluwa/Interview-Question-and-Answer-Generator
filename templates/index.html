<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Question Creator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        #result, #download, #qa-list { display: none; }
        .progress { height: 25px; margin: 15px 0; }
        .current-qa { background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .qa-item { border-bottom: 1px solid #eee; padding: 10px 0; animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .question { font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .answer { color: #7f8c8d; font-style: italic; }
        .question-number { 
            background: #007bff; 
            color: white; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 10px; 
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-dark text-white">
<section>
    <div class="container-fluid text-center p-5">
        <h3>Interview Question Creator</h3>
    </div>
</section>

<section class="mb-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-8">
                <div class="card p-5 shadow border-0">
                    <div class="mb-3">
                        <label class="form-label">Upload your PDF file here</label>
                        <input type="file" class="form-control" id="pdf-file" accept=".pdf">
                    </div>
                    <div class="mb-3 text-end">
                        <button type="button" id="upload-btn" class="btn btn-success">
                            <span id="btn-text">Generate Q&A</span>
                            <span id="btn-spinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="result">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 mb-3">
                <div class="card shadow border-0 p-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">PDF Preview</h5>
                    </div>
                    <div class="card-body">
                        <embed id="view-pdf" src="" width="100%" height="600px" />
                    </div>
                </div>
            </div>
            <div class="col-sm-6 mb-3">
                <div class="card shadow border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Processing Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="progress-section">
                            <div class="d-flex justify-content-between mb-2">
                                <span id="status-text">Initializing...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="progress">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div id="progress-stats" class="text-center mt-2">
                                Processed: <span id="current-question">0</span>/<span id="total-questions">0</span> questions
                            </div>
                            
                            <div id="current-qa-container" class="current-qa" style="display: none;">
                                <h6>Currently Processing:</h6>
                                <div class="question" id="current-question-text"></div>
                                <div class="answer" id="current-answer-text"></div>
                            </div>
                        </div>

                        <div id="loader" class="text-center py-4">
                            <div class="spinner-border text-warning" role="status"></div>
                            <p class="mt-3">Starting processing...</p>
                        </div>

                        <div id="download" class="text-center py-4">
                            <div class="alert alert-success">
                                <h5>âœ… Processing Complete!</h5>
                                <p>Your professional Q&A document is ready for download.</p>
                                <a href="" id="download-btn" class="btn btn-warning btn-lg" download style="display: none;">
                                    ðŸ“¥ Download Interview Questions & Answers
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="qa-list" class="card shadow border-0 mt-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Generated Questions & Answers</h5>
                        <small class="opacity-75">Total: <span id="total-generated">0</span> questions</small>
                    </div>
                    <div class="card-body">
                        <div id="qa-items"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let result = document.getElementById('result');
let loader = document.getElementById('loader');
let download = document.getElementById('download');
let progressSection = document.getElementById('progress-section');
let statusText = document.getElementById('status-text');
let progressPercent = document.getElementById('progress-percent');
let progressBar = document.getElementById('progress-bar');
let currentQuestion = document.getElementById('current-question');
let totalQuestions = document.getElementById('total-questions');
let currentQaContainer = document.getElementById('current-qa-container');
let currentQuestionText = document.getElementById('current-question-text');
let currentAnswerText = document.getElementById('current-answer-text');
let qaList = document.getElementById('qa-list');
let qaItems = document.getElementById('qa-items');
let uploadBtn = document.getElementById('upload-btn');
let btnText = document.getElementById('btn-text');
let btnSpinner = document.getElementById('btn-spinner');
let downloadBtn = document.getElementById('download-btn');
let totalGenerated = document.getElementById('total-generated');

let allQAs = [];

function updateProgress(progress, current, total) {
    progressBar.style.width = `${progress}%`;
    progressBar.setAttribute('aria-valuenow', progress);
    progressPercent.textContent = `${progress}%`;
    currentQuestion.textContent = current;
    totalQuestions.textContent = total;
    
    if (progress < 100) {
        statusText.textContent = `Processing questions...`;
    } else {
        statusText.textContent = `Complete!`;
        progressBar.classList.remove('progress-bar-animated');
    }
}

function displayCurrentQA(index, question, answer) {
    if (question && answer) {
        currentQaContainer.style.display = 'block';
        currentQuestionText.innerHTML = `<span class="question-number">${index}</span> ${question}`;
        currentAnswerText.innerHTML = `<span class="question-number">${index}</span> ${answer}`;
        addQAToList(index, question, answer);
    }
}

function cleanText(text) {
    return text.replace(/[*_`]/g, '');
}

function displayCurrentQA(index, question, answer) {
    if (question && answer) {
        currentQaContainer.style.display = 'block';
        currentQuestionText.innerHTML = `<span class="question-number">${index}</span> ${cleanText(question)}`;
        currentAnswerText.innerHTML = `<span class="question-number">${index}</span> ${cleanText(answer)}`;
        addQAToList(index, cleanText(question), cleanText(answer));
    }
}

function addQAToList(index, question, answer) {
    const qaItem = document.createElement('div');
    qaItem.className = 'qa-item';
    qaItem.innerHTML = `
        <div class="question">
            <span class="question-number">${index}</span>${question}
        </div>
        <div class="answer">
            <span class="question-number">${index}</span>${answer}
        </div>
    `;
    qaItems.appendChild(qaItem);
    qaItems.scrollTop = qaItems.scrollHeight;
    
    // Update total generated count
    totalGenerated.textContent = allQAs.length;
}

function resetButton() {
    uploadBtn.disabled = false;
    btnText.textContent = "Generate Q&A";
    btnSpinner.style.display = 'none';
}

$(document).ready(function () {
    $("#upload-btn").click(async function () {
        const fileInput = document.getElementById('pdf-file');
        const file = fileInput.files[0];           
        if (!file) { 
            Swal.fire({ icon: 'error', title: 'Oops!', text: "No file selected" });
            return;
        }

        uploadBtn.disabled = true;
        btnText.textContent = "Processing...";
        btnSpinner.style.display = 'inline-block';

        const formData = new FormData();
        formData.append('pdf_file', file);
        formData.append('filename', file.name);

        try {
            let response = await fetch('/upload', { method: "POST", body: formData });
            if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
            const uploadJson = await response.json();

            result.style.display = "block";
            loader.style.display = "block";
            progressSection.style.display = "block";
            download.style.display = "none";
            qaList.style.display = "none";
            qaItems.innerHTML = '';
            allQAs = [];
            totalGenerated.textContent = '0';
            downloadBtn.style.display = 'none'; // Hide download button initially
            
            updateProgress(0, 0, 0);
            document.getElementById('view-pdf').setAttribute('src', "/" + uploadJson.pdf_filename);

            const analyzeForm = new FormData();
            analyzeForm.append('pdf_filename', uploadJson.pdf_filename);
            let analyzeResp = await fetch('/analyze', { method: "POST", body: analyzeForm });
            if (!analyzeResp.ok) throw new Error(`Analysis failed: ${analyzeResp.status}`);
            const analyzeJson = await analyzeResp.json();
            
            loader.style.display = "none";
            progressSection.style.display = "block";
            pollJobStatus(analyzeJson.job_id);
            
        } catch (error) {
            console.error("Error:", error);
            Swal.fire({ icon: 'error', title: 'Oops!', text: error.message });
            resetButton();
        }
    });
});

async function pollJobStatus(jobId) {
    let status = "queued";
    let pollCount = 0;
    const maxPolls = 1200;
    let lastData = null;
    
    while ((status === "queued" || status === "processing") && pollCount < maxPolls) {
        try {
            let resp = await fetch(`/status/${jobId}`);
            if (!resp.ok) throw new Error(`Status check failed: ${resp.status}`);
            let data = await resp.json();
            status = data.status;
            lastData = data; // Store the last response data
            pollCount++;
            
            if (data.progress !== undefined) {
                updateProgress(data.progress, data.current_question || 0, data.total_questions || 0);
            }
            
            if (data.current_qa) {
                // Store in allQAs if not already there
                const existingIndex = allQAs.findIndex(qa => qa.index === data.current_qa.index);
                if (existingIndex === -1) {
                    allQAs.push(data.current_qa);
                    displayCurrentQA(data.current_qa.index, data.current_qa.question, data.current_qa.answer);
                }
            }
            
            // Update download link whenever we get a file path
            if (data.file) {
                console.log("File path received:", data.file);
                downloadBtn.setAttribute('href', "/" + data.file);
                
                // Set professional download filename if available
                if (data.download_filename) {
                    downloadBtn.setAttribute('download', data.download_filename);
                }
                downloadBtn.style.display = 'block';
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
        } catch (error) {
            console.error("Polling error:", error);
            statusText.textContent = "Error checking status";
            Swal.fire({ icon: 'error', title: 'Status Check Failed', text: error.message });
            resetButton();
            break;
        }
    }

    // Handle final status
    if (status === "done") {
        // FIX: Use lastData which contains the correct totals
        updateProgress(100, lastData.current_question, lastData.total_questions);
        currentQaContainer.style.display = 'none';
        progressSection.style.display = "none";
        download.style.display = "block";
        qaList.style.display = "block";
        
        // Update the total generated count in the header
        totalGenerated.textContent = allQAs.length;
        
        // Ensure download link is set
        if (lastData && lastData.file) {
            downloadBtn.setAttribute('href', "/" + lastData.file);
            
            // Set professional filename for download
            if (lastData.download_filename) {
                downloadBtn.setAttribute('download', lastData.download_filename);
                console.log("Professional filename set to:", lastData.download_filename);
            }
            
            downloadBtn.style.display = 'block';
            console.log("Final download link set to:", "/" + lastData.file);
        } else {
            // If no file in last response, try to get it one more time
            try {
                let finalResp = await fetch(`/status/${jobId}`);
                if (finalResp.ok) {
                    let finalData = await finalResp.json();
                    if (finalData.file) {
                        downloadBtn.setAttribute('href', "/" + finalData.file);
                        if (finalData.download_filename) {
                            downloadBtn.setAttribute('download', finalData.download_filename);
                        }
                        downloadBtn.style.display = 'block';
                        console.log("Final download link (retrieved):", "/" + finalData.file);
                    }
                }
            } catch (e) {
                console.error("Failed to get final file path:", e);
            }
        }
        
        Swal.fire({ 
            icon: 'success', 
            title: 'Success!', 
            text: `Generated ${allQAs.length} questions and answers successfully!` 
        });
        
    } else if (status === "failed") {
        statusText.textContent = "Processing failed";
        progressSection.style.display = "none";
        loader.style.display = "none";
        Swal.fire({ 
            icon: 'error', 
            title: 'Processing Failed', 
            text: 'The Q&A generation process failed. Please try again.' 
        });
    } else if (pollCount >= maxPolls) {
        statusText.textContent = "Processing timeout";
        progressSection.style.display = "none";
        loader.style.display = "none";
        Swal.fire({ 
            icon: 'warning', 
            title: 'Timeout', 
            text: 'The processing is taking longer than expected. Please try again.' 
        });
    }
    
    resetButton();
}
</script>
</body>
</html>